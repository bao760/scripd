-- SDVT BF - Rayfield (Robust wrapper cho nhi·ªÅu bi·∫øn th·ªÉ Sirius/ Rayfield)
-- D√°n ch·∫°y trong executor sau khi b·∫°n ƒë√£ load Rayfield b·∫±ng:
-- local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

-- N·∫øu b·∫°n ch∆∞a load, script n√†y s·∫Ω t·ª± load n·∫øu c√≥ k·∫øt n·ªëi:
local function safe_load_rayfield()
    local ok, Rayfield = pcall(function()
        return loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
    end)
    if ok and Rayfield then return Rayfield end
    return nil, "Cannot load Rayfield from https://sirius.menu/rayfield"
end

local Rayfield = safe_load_rayfield()
if not Rayfield then
    warn("SDVT BF: Kh√¥ng t·∫£i ƒë∆∞·ª£c Rayfield loader. H√£y ch·∫Øc b·∫°n ƒëang c√≥ k·∫øt n·ªëi ho·∫∑c loader h·ª£p l·ªá.")
    return
end

-- ===== Helper: wrapper ƒë·ªÉ t∆∞∆°ng th√≠ch nhi·ªÅu API =====
local function create_window(opts)
    -- nhi·ªÅu b·∫£n Rayfield d√πng key kh√°c nhau: CreateWindow, CreateWindow? or Rayfield:CreateWindow
    local win
    local ok, res

    -- try Rayfield:CreateWindow({...})
    ok, res = pcall(function() return Rayfield:CreateWindow(opts) end)
    if ok and res then return res end

    -- try Rayfield.CreateWindow(Rayfield, {...})
    ok, res = pcall(function() return Rayfield.CreateWindow(Rayfield, opts) end)
    if ok and res then return res end

    -- try alternate names
    ok, res = pcall(function() return Rayfield:Window(opts) end)
    if ok and res then return res end

    ok, res = pcall(function() return Rayfield.Window(Rayfield, opts) end)
    if ok and res then return res end

    error("SDVT BF: Kh√¥ng t√¨m th·∫•y ph∆∞∆°ng th·ª©c t·∫°o Window trong Rayfield.")
end

local function create_tab(window, name)
    local ok, res
    -- nhi·ªÅu API: CreateTab, Tab, CreatePage, NewTab
    local tries = {
        function() return window:CreateTab(name) end,
        function() return window.CreateTab(window, name) end,
        function() return window:Tab(name) end,
        function() return window.Tab(window, name) end,
        function() return window:CreatePage(name) end,
        function() return window.CreatePage(window, name) end,
        function() return window:NewTab(name) end,
        function() return window.NewTab(window, name) end,
    }
    for _, fn in ipairs(tries) do
        ok, res = pcall(fn)
        if ok and res then return res end
    end
    error("SDVT BF: Kh√¥ng t√¨m th·∫•y ph∆∞∆°ng th·ª©c t·∫°o Tab trong Window.")
end

local function tab_label(tab, text)
    local ok
    local tries = {
        function() return tab:CreateLabel(text) end,
        function() return tab.CreateLabel(tab, text) end,
        function() return tab:Label(text) end,
        function() return tab.Label(tab, text) end,
        function() return tab:CreateSection(text) end, -- ph·∫ßn n√†o ƒë√≥ d√πng section
    }
    for _, fn in ipairs(tries) do
        ok = pcall(fn)
        if ok then return true end
    end
    return false
end

local function tab_paragraph(tab, title, content)
    local ok
    local tries = {
        function() return tab:CreateParagraph({Title = title, Content = content}) end,
        function() return tab.CreateParagraph(tab, {Title = title, Content = content}) end,
        function() return tab:Paragraph(title, content) end,
        function() return tab.Paragraph(tab, title, content) end,
    }
    for _, fn in ipairs(tries) do
        ok = pcall(fn)
        if ok then return true end
    end
    return false
end

local function tab_button(tab, opts)
    -- opts = {Title, Description, Callback}
    local ok, res
    local tries = {
        function() return tab:CreateButton({Name = opts.Title or opts.title, Description = opts.Description or opts.description, Callback = opts.Callback}) end,
        function() return tab.CreateButton(tab, {Name = opts.Title or opts.title, Description = opts.Description or opts.description, Callback = opts.Callback}) end,
        function() return tab:Button({Title = opts.Title or opts.title, Description = opts.Description or opts.description, Callback = opts.Callback}) end,
        function() return tab.Button(tab, {Title = opts.Title or opts.title, Description = opts.Description or opts.description, Callback = opts.Callback}) end,
        function() return tab:Button(opts.Title or opts.title, opts.Callback) end,
        function() return tab.Button(tab, opts.Title or opts.title, opts.Callback) end,
        function() return tab:CreateToggle({Name = opts.Title or opts.title, CurrentValue = false, Callback = function() end}) end
    }
    for _, fn in ipairs(tries) do
        ok, res = pcall(fn)
        if ok then return res end
    end
    error("SDVT BF: Kh√¥ng th·ªÉ t·∫°o button tr√™n Tab (API kh√¥ng kh·ªõp).")
end

local function notify(...) -- ƒëa nƒÉng: nhi·ªÅu b·∫£n s·ª≠ d·ª•ng Notify({...}) ho·∫∑c Notify(str, time)
    local ok
    local args = {...}
    -- Try multiple signatures
    ok = pcall(function() Rayfield:Notify(unpack(args)) end)
    if ok then return true end
    ok = pcall(function() Rayfield.Notify(Rayfield, unpack(args)) end)
    if ok then return true end
    -- try single string
    if type(args[1]) == "string" then
        ok = pcall(function() Rayfield:Notify({Title = "SDVT BF", Content = args[1], Duration = args[2] or 4}) end)
        if ok then return true end
    end
    return false
end

-- ===== T·∫°o UI =====
local win_ok, window = pcall(function()
    return create_window({
        Title = "SDVT BF",
        SubTitle = "Sirius-compatible",
        LoadingTitle = "SDVT BF",
        KeySystem = false
    })
end)
if not win_ok then
    warn("SDVT BF: T·∫°o window th·∫•t b·∫°i:", window)
    return
end

local infoTab, serverTab
local ok, res = pcall(function() infoTab = create_tab(window, "Info") end)
if not ok then
    warn("SDVT BF: T·∫°o tab Info l·ªói:", res)
    return
end
ok, res = pcall(function() serverTab = create_tab(window, "Server") end)
if not ok then
    warn("SDVT BF: T·∫°o tab Server l·ªói:", res)
    return
end

-- Fill Info tab
pcall(function() tab_label(infoTab, "Script: SDVT BF (Sirius-compatible)") end)
pcall(function() tab_paragraph(infoTab, "T√≠nh nƒÉng", "Hop Low Server - t√¨m server √≠t ng∆∞·ªùi v√† teleport v√†o.") end)
pcall(function() tab_paragraph(infoTab, "H∆∞·ªõng d·∫´n", "V√†o tab Server, b·∫•m n√∫t Hop Low Server.") end)

-- ===== Server logic =====
local PLACE_ID = game.PlaceId

local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")

local function find_low_server(limit_per_page)
    limit_per_page = limit_per_page or 100
    local cursor = nil
    local best = nil
    repeat
        local url = string.format("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=%d", PLACE_ID, limit_per_page)
        if cursor then url = url .. "&cursor=" .. tostring(cursor) end
        local ok, body = pcall(function() return game:HttpGet(url) end)
        if not ok or not body then
            return nil, "http_error"
        end
        local ok2, data = pcall(function() return HttpService:JSONDecode(body) end)
        if not ok2 or not data then
            return nil, "json_error"
        end
        if data.data then
            for _, s in ipairs(data.data) do
                if s.playing and s.maxPlayers and s.playing < s.maxPlayers then
                    if not best or s.playing < best.playing then
                        best = s
                    end
                end
            end
        end
        cursor = data.nextPageCursor
        task.wait(0.25)
    until not cursor
    if best then return best end
    return nil, "no_server"
end

-- Button callback
local function on_hop_pressed()
    notify("ƒêang t√¨m server √≠t ng∆∞·ªùi...", 3)
    local srv, err = find_low_server(100)
    if not srv then
        notify("Kh√¥ng t√¨m th·∫•y server: " .. tostring(err), 4)
        return
    end
    notify("T√¨m th·∫•y server (ng∆∞·ªùi: " .. tostring(srv.playing) .. ") - Teleport...", 3)
    local ok, e = pcall(function()
        TeleportService:TeleportToPlaceInstance(PLACE_ID, srv.id, Players.LocalPlayer)
    end)
    if not ok then
        notify("Teleport l·ªói: " .. tostring(e), 5)
    end
end

-- T·∫°o n√∫t tr√™n tab Server (d√πng wrapper try multiple APIs)
local success, btn = pcall(function()
    return tab_button(serverTab, {
        Title = "üîÑ Hop Low Server",
        Description = "T√¨m server √≠t ng∆∞·ªùi nh·∫•t v√† teleport v√†o",
        Callback = on_hop_pressed
    })
end)
if not success then
    warn("SDVT BF: T·∫°o button th·∫•t b·∫°i:", btn)
    -- fallback: c·ªë g·∫Øng t·∫°o label h∆∞·ªõng d·∫´n
    pcall(function() tab_label(serverTab, "N·∫øu n√∫t kh√¥ng hi·ªán, h√£y ki·ªÉm tra API Rayfield b·∫°n ƒëang d√πng.") end)
else
    -- th√™m nh√£n h∆∞·ªõng d·∫´n
    pcall(function() tab_label(serverTab, "‚û° Nh·∫•n n√∫t tr√™n ƒë·ªÉ hop server √≠t ng∆∞·ªùi.") end)
end

-- Notify ready
notify("‚úÖ SDVT BF ƒë√£ t·∫£i (Sirius-compatible).", 4)
